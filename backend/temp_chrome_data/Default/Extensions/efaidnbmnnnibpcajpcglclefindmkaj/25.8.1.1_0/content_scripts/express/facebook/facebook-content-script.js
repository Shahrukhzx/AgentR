/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class FacebookExpressIntegration{previewEntryPointId="facebook-preview-adobe-express-entry-point";previewedImageClassname=["x15mokao x1ga7v0g x16uus16 xbiv7yw x193iq5w x4fas0m x19kjcj4"];previewHeaderClassname=["x9f619 x1ja2u2z x78zum5 x2lah0s x1n2onr6 x13a6bvl x1qjc9v5 xozqiw3 x1q0g3np xpdmqnj x1g0dm76 xyamay9 x1ws5yxj xw01apr x4cne27 xifccgj"];touchpoint="facebookPreview";shownTouchpointOnce=!1;minifiedButton=!1;launchExpress=(e,t,n)=>{chrome.runtime.sendMessage({main_op:"launch-express",imgUrl:e,intent:n,touchpoint:t})};sendAnalyticsEvent=e=>{try{chrome.runtime.sendMessage({main_op:"analytics",analytics:e})}catch(e){}};sendErrorLog=(e,t)=>{chrome.runtime.sendMessage({main_op:"log-error",log:{message:e,error:t}})};async loadContentScripts(){const e=chrome.runtime.getURL("content_scripts/express/single-click-cta.js"),t=await import(e);this.ExpressCTAClass=t.default,this.expressCTA=new this.ExpressCTAClass}_getImageElementFromSelector=e=>{for(let t of e){let e=document.getElementsByClassName(t)[0];if(e)return e}return null};_getImageAndHeaderElementFromSelector=(e,t)=>{let n=null;const i=this._getImageElementFromSelector(e);if(!i)return{imageElement:i,headerElement:n};for(let e of t){const t=document.getElementsByClassName(e);if(t.length>0)for(let e of t)if(e?.parentElement?.parentElement?.contains(i)){n=e;break}}return{imageElement:i,headerElement:n}};addThumbnailAndImagePreviewerObserver=()=>{new MutationObserver(()=>{this.config.enableFacebookPreviewExpressMenu&&this.imagePreviewerObserverHandler()}).observe(document.body,{childList:!0,subtree:!0})};previewEntryPointClickHandler=e=>{if(!chrome?.runtime?.id)return void this.cleanup();const t=this._getImageElementFromSelector(this.previewedImageClassname);if(!t||"IMG"!==t.tagName)return void this.sendErrorLog("Error executing express in facebook","image element not found");const n=t.src;n?this.launchExpress(n,this.touchpoint,e):this.sendErrorLog("Error executing express in facebook","image URL not found")};toggleButtonSize=(e,t=document)=>{const n=t.getElementsByClassName("cc440d50ba-express-entrypoint-button-text")[0];if(!n)return;n.classList?.toggle("minified",e);const i=t.getElementsByClassName("cc440d50ba-express-entrypoint-button-icon")[0];i&&i.classList.toggle("minified",e)};imagePreviewerObserverHandler=()=>{if(!chrome?.runtime?.id)return void this.cleanup();const{imageElement:e,headerElement:t}=this._getImageAndHeaderElementFromSelector(this.previewedImageClassname,this.previewHeaderClassname);if(!t)return void this.cleanup();const n=document.getElementById(this.previewEntryPointId);e&&"IMG"===e.tagName?n||(this.cleanupTooltip(),this.addPreviewEntryPoint(t,e,this.previewEntryPointId,this.previewEntryPointClickHandler),this.shownTouchpointOnce||(this.sendAnalyticsEvent([["DCBrowserExt:Express:Facebook:PreviewEntryPoint:Shown"]]),this.shownTouchpointOnce=!0)):this.cleanup()};buttonResizeHandler=()=>{const e=this._getImageElementFromSelector(this.previewedImageClassname),t=document.getElementById(this.previewEntryPointId);if(!e||!t)return;const n=e.getBoundingClientRect(),i=t.getBoundingClientRect();0===i.width&&0===i.height||n.right>=i.left&&n.top<=i.bottom&&setTimeout(()=>{this.minifiedButton=!0,this.toggleButtonSize(this.minifiedButton)},1e3)};tooltipDelayCallback=()=>this.minifiedButton?1500:400;addPreviewEntryPoint=async(e,t,n,i)=>{if(document.getElementById(n)||this.buttonRenderStarted)return;this.buttonRenderStarted=!0;const s=await this.expressCTA.renderMenuButton(i,this.touchpoint);if(s.id=n,this.toggleButtonSize(this.minifiedButton,s),e.insertBefore(s,e.firstChild),this.tooltip=this.expressCTA.attachTooltip("bottom",this.tooltipDelayCallback),this.buttonRenderStarted=!1,t.addEventListener("load",()=>{this.buttonResizeHandler()}),this.minifiedButton)return;const o=new MutationObserver(()=>{this.buttonResizeHandler(),this.minifiedButton&&o.disconnect()});o.observe(e.parentElement.parentElement,{childList:!0,subtree:!0,attributes:!0});const r=new ResizeObserver(()=>{this.buttonResizeHandler(),this.minifiedButton&&r.disconnect()});r.observe(e.parentElement.parentElement)};removePreviewEntryPoint=e=>{const t=document.getElementById(e);t&&t.remove()};cleanup=()=>{this.removePreviewEntryPoint(this.previewEntryPointId),this.cleanupTooltip()};cleanupTooltip=()=>{this.tooltip?.tooltip?.remove(),this.tooltip=null;const e=document.getElementsByClassName("cc440d50ba-tooltiptext");for(let t of e)t.remove()};init=async()=>{const e=await chrome.runtime.sendMessage({main_op:"facebook-express-init"});this.config=e,this.config.enableFacebookPreviewExpressMenu&&(this.previewedImageClassname=this.config.selectors?.previewedImageClassname||this.previewedImageClassname,this.previewHeaderClassname=this.config.selectors?.previewHeaderClassname||this.previewHeaderClassname,await this.loadContentScripts(),this.addThumbnailAndImagePreviewerObserver())}}const facebookExpressIntegration=new FacebookExpressIntegration;facebookExpressIntegration.init();